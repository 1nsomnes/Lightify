<!DOCTYPE html>
<html>

<head>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <script>


    window.onSpotifyWebPlaybackSDKReady = () => {
      window.token = '{token}';

      console.log("current token = " + token)
      const player = new Spotify.Player({
        name: 'Lightify',
        getOAuthToken: cb => {cb(window.token);},
        volume: 1
      });
      console.log("spotify play back ready")

      player.addListener('ready', ({device_id}) => {
        console.log("ready with id " + device_id)
        return_object = {
          func: "setDeviceId",
          body: {
            "device_id": device_id
          }
        }

        window.spotifyPlayer = player;
        FlutterHost.postMessage(JSON.stringify(return_object));
      });

      player.addListener('not_ready', ({device_id}) => {
        console.log('Device ID has gone offline', device_id);
      });
      player.addListener('initialization_error', ({message}) => {
        console.error(message);
      });

      player.addListener('authentication_error', ({message}) => {
        console.log("Authentication Failed");
        return_object = {
          func: "authenticationFailed"
        };
        FlutterHost.postMessage(JSON.stringify(return_object));
      });

      player.addListener('account_error', ({message}) => {
        console.error(message);
      });

      player.addListener('player_state_changed', ({
        position,
        duration,
        track_window: {current_track}
      }) => {

        //TODO: possibly remove this update
        current_track["position_ms"] = position;
        return_object = {
          func: "updateData",
          body: current_track
        };

        FlutterHost.postMessage(JSON.stringify(return_object));

        window.spotifyPlayer.getCurrentState().then(state => {
          if (!state) {
            console.log("no state")
            return;
          }

          return_object = {
            func: "updateDataFromPlayer",
            body: state
          };

          FlutterHost.postMessage(JSON.stringify(return_object));
        })
      });

      player.connect();
    }

    function togglePlayback() {
      console.log("Toggling Play")
      window.spotifyPlayer.togglePlay();
    }

    function next() {
      console.log("Skipping song")
      window.spotifyPlayer.nextTrack();

    }

    function previous() {
      console.log("Going back a song")
      window.spotifyPlayer.previousTrack();
    }

    function reconnect() {
      console.log("Reconnect");
      window.spotifyPlayer.connect();
    }

    function setToken(token) {
      console.log("Token updated to " + token);
      window.token = token;
    }

  </script>
</head>


</html>
