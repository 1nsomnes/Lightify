<!DOCTYPE html>
<html>

<head>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <script>



    function playBeep() {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(440, ctx.currentTime); // 440 Hz = A4
      osc.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.2); // play for 0.2 seconds
    }

    window.addEventListener('DOMContentLoaded', () => {
      playBeep();
    });


    window.onSpotifyWebPlaybackSDKReady = () => {
      const token = '{token}';

      console.log("current token = " + token)
      const player = new Spotify.Player({
        name: 'Lightify',
        getOAuthToken: cb => {cb(token);},
        volume: 1
      });
      console.log("spotify play back ready")

      player.addListener('ready', ({device_id}) => {
        console.log("ready with id " + device_id)
        return_object = {
          func: "setDeviceId",
          body: {
            "device_id": device_id
          }
        }

        window.spotifyPlayer = player;
        FlutterHost.postMessage(JSON.stringify(return_object));
      });

      player.addListener('not_ready', ({device_id}) => {
        console.log('Device ID has gone offline', device_id);
      });
      player.addListener('initialization_error', ({message}) => {
        console.error(message);
      });

      player.addListener('authentication_error', ({message}) => {
        console.error(message);
      });

      player.addListener('account_error', ({message}) => {
        console.error(message);
      });

      player.addListener('player_state_changed', ({
        position,
        duration,
        track_window: {current_track}
      }) => {
        current_track["position_ms"] = position;
        return_object = {
          func: "updateData",
          body: current_track
        };
        FlutterHost.postMessage(JSON.stringify(return_object));
        console.log('Currently Playing', current_track);
      });

      player.connect();
    }

    function togglePlayback() {
      console.log("Toggling Play")
      window.spotifyPlayer.togglePlay();
    }

    function next() {
      console.log("Skipping song")
      window.spotifyPlayer.nextTrack();

    }

    function previous() {
      console.log("Going back a song")
      window.spotifyPlayer.previousTrack();
    }

  </script>
</head>


</html>
